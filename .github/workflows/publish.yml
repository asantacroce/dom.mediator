name: Publish NuGet Package

on:
  push:
    branches:
      - "**"
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            9.0.x

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name: Run tests with coverage
        run: dotnet test --no-build --configuration Release --verbosity normal --collect:"XPlat Code Coverage" --logger "trx" --results-directory ./tests/TestResults

      - name: Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Generate coverage report
        run: reportgenerator -reports:"./tests/TestResults/**/coverage.cobertura.xml" -targetdir:"./tests/CoverageReport" -reporttypes:"Html;Cobertura;TextSummary;MarkdownSummary;Badges"

      - name: Display coverage summary
        run: cat ./tests/CoverageReport/Summary.txt

      - name: Add coverage to GitHub Summary
        run: |
          echo "## ðŸ“Š Code Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat ./tests/CoverageReport/Summary.md >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Coverage Badges" >> $GITHUB_STEP_SUMMARY
          echo "![Line Coverage](./tests/CoverageReport/badge_linecoverage.svg)" >> $GITHUB_STEP_SUMMARY
          echo "![Branch Coverage](./tests/CoverageReport/badge_branchcoverage.svg)" >> $GITHUB_STEP_SUMMARY
          echo "![Method Coverage](./tests/CoverageReport/badge_methodcoverage.svg)" >> $GITHUB_STEP_SUMMARY

      - name: Check coverage threshold
        run: |
          # Extract line coverage percentage from summary
          COVERAGE=$(grep "Line coverage:" ./tests/CoverageReport/Summary.txt | grep -o '[0-9]*\.[0-9]*' | head -1)
          echo "Current line coverage: ${COVERAGE}%"
          
          # Set minimum coverage threshold (adjust as needed)
          THRESHOLD=60
          
          if (( $(echo "${COVERAGE} < ${THRESHOLD}" | bc -l) )); then
            echo "âŒ Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
            echo "::warning::Code coverage ${COVERAGE}% is below the minimum threshold of ${THRESHOLD}%"
          else
            echo "âœ… Coverage ${COVERAGE}% meets threshold ${THRESHOLD}%"
          fi

      - name: Comment coverage on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('./tests/CoverageReport/Summary.md', 'utf8');
            
            const body = `## ðŸ“Š Code Coverage Report
            
            ${summary}
            
            **ðŸ“ [Download Full HTML Report](../actions/runs/${{ github.run_id }})**
            
            > Coverage report generated for commit ${{ github.sha }}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: |
            ./tests/CoverageReport/
            ./tests/TestResults/**/coverage.cobertura.xml

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: ./tests/TestResults/**/*.trx

      - name: Deploy coverage to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: success()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./tests/CoverageReport
          destination_dir: coverage
          keep_files: true

  publish:
    needs: test  # Only publish if tests pass
    runs-on: ubuntu-latest
    if: success()  # Only run if test job succeeds

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore Dom.Mediator/Dom.Mediator.csproj

      - name: Build
        run: dotnet build Dom.Mediator/Dom.Mediator.csproj -c Release --no-restore

      - name: Copy README and LICENSE into package folder
        run: |
            cp README.md Dom.Mediator/README.md
            cp LICENSE Dom.Mediator/LICENSE

      - name: Pack NuGet package
        run: dotnet pack Dom.Mediator/Dom.Mediator.csproj -c Release --no-build --output ./nupkg

      - name: Push to NuGet
        run: dotnet nuget push ./nupkg/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
